<full-calendar [options]="calendarOptions"></full-calendar>

<div class="event-modal" *ngIf="showEventModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>AdaugÄƒ eveniment nou</h3>
      <button class="close-btn" (click)="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="eventForm">
        <div class="form-group">
          <label for="eventName" class="required-label">
            Numele evenimentului:
            <span class="required-asterisk">*</span>
          </label>
          <input 
            type="text" 
            id="eventName" 
            formControlName="name" 
            placeholder="Introdu numele evenimentului"
            [class.form-control]="true"
            [class.error-field]="eventForm.get('name')?.invalid && eventForm.get('name')?.touched">
        </div>
        
        <div class="form-group">
          <label for="eventDescription" class="required-label">
            Descriere:
            <span class="required-asterisk">*</span>
          </label>
          <textarea 
            id="eventDescription" 
            formControlName="description" 
            placeholder="Descriere eveniment"
            [class.form-control]="true"
            [class.error-field]="eventForm.get('description')?.invalid && eventForm.get('description')?.touched"
            rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="eventLocation">LocaÈ›ia:</label>
          <input 
            type="text" 
            id="eventLocation" 
            formControlName="location" 
            placeholder="Introdu locaÈ›ia evenimentului"
            class="form-control">
        </div>
        
        <div class="form-group">
          <label for="eventType">Tipul:</label>
          <select id="eventType" formControlName="eventType" class="form-control">
            <option value="eveniment">Eveniment</option>
            <option value="expozitie">ExpoziÈ›ie temporarÄƒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="startDate" class="required-label">
            Data Ã®nceput:
            <span class="required-asterisk">*</span>
          </label>
          <input 
            type="date" 
            id="startDate" 
            formControlName="startDate" 
            [class.form-control]="true"
            [class.date-input]="true"
            [class.error-field]="eventForm.get('startDate')?.invalid && eventForm.get('startDate')?.touched">
          <div class="error-message" *ngIf="eventForm.errors?.['startDateOutOfRange']">
            Data de Ã®nceput trebuie sÄƒ fie Ã®n intervalul permis
          </div>
        </div>
        
        <div class="form-group">
          <label for="endDate" class="required-label">
            Data sfÃ¢rÈ™it:
            <span class="required-asterisk">*</span>
          </label>
          <input 
            type="date" 
            id="endDate" 
            formControlName="endDate" 
            [class.form-control]="true"
            [class.date-input]="true"
            [class.error-field]="eventForm.get('endDate')?.invalid && eventForm.get('endDate')?.touched">
          <div class="error-message" *ngIf="eventForm.errors?.['dateOrder']">
            Data de sfÃ¢rÈ™it trebuie sÄƒ fie dupÄƒ data de Ã®nceput
          </div>
          <div class="error-message" *ngIf="eventForm.errors?.['endDateOutOfRange']">
            Data de sfÃ¢rÈ™it trebuie sÄƒ fie Ã®n intervalul permis
          </div>
        </div>
        
        <div class="form-group">
          <label>AdaugÄƒ imagini:</label>
          <div class="image-upload">
            <label for="imageUpload" class="upload-btn">
              <span>SelecteazÄƒ imagini</span>
              <input 
                type="file" 
                id="imageUpload" 
                accept="image/*" 
                (change)="onFileSelected($event)" 
                class="file-input">
            </label>
            <div *ngIf="selectedFile" class="selected-file">
              {{ selectedFile.name }}
              <button type="button" class="upload-action-btn" (click)="uploadImage()">ÃncarcÄƒ</button>
              <button type="button" class="upload-action-btn cancel" (click)="cancelUpload()">AnuleazÄƒ</button>
            </div>
          </div>
          
          <div *ngIf="uploadProgress > 0 && uploadProgress < 100" class="upload-progress">
            <div class="progress-bar" [style.width.%]="uploadProgress"></div>
            <span class="progress-text">{{ uploadProgress }}%</span>
          </div>
          
          <div *ngIf="selectedImages.length > 0" class="selected-images">
            <h4>Imagini selectate:</h4>
            <div class="image-list">
              <div class="image-item" *ngFor="let image of selectedImages; let i = index">
                <div class="image-preview">
                  <img [src]="'http://localhost:8080/api/images/uploads/' + image.path" alt="Preview">
                </div>
                <span>{{ image.path | slice:0:20 }}{{ image.path.length > 20 ? '...' : '' }}</span>
                <button type="button" class="remove-btn" (click)="removeImage(i)">È˜terge</button>
              </div>
            </div>
          </div>
        </div>
        
      </form>
    </div>
    
    <div class="form-error" *ngIf="formError">
      <div class="error-message-box">
        <pre class="error-content">{{ formError }}</pre>
      </div>
    </div>
    
    <div class="form-actions">
      <button 
        type="button" 
        class="cancel-btn" 
        (click)="closeModal()">
        AnuleazÄƒ
      </button>
      <button 
        type="button" 
        class="save-btn" 
        [disabled]="eventForm.invalid"
        (click)="saveEvent()">
        SalveazÄƒ
      </button>
    </div>
  </div>
</div>

<div class="event-details-modal" *ngIf="showEventDetailsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{ selectedEvent?.title }}</h3>
      <button class="close-btn" (click)="closeEventDetailsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="event-date">
        <span class="label">Data:</span> 
        <span class="value">{{ selectedEvent?.start | date:'dd MMMM yyyy' }} - {{ selectedEvent?.end | date:'dd MMMM yyyy' }}</span>
      </div>
      <div class="event-location" *ngIf="selectedEvent?.extendedProps?.location">
        <span class="label">LocaÈ›ie:</span>
        <span class="value">{{ selectedEvent?.extendedProps?.location }}</span>
      </div>
      <div class="event-description" *ngIf="selectedEvent?.extendedProps?.description">
        <span class="label">Descriere:</span>
        <p class="value">{{ selectedEvent?.extendedProps?.description }}</p>
      </div>
      <div class="event-images" *ngIf="selectedEvent?.extendedProps?.images && selectedEvent?.extendedProps?.images.length > 0">
        <h4>Galerie imagini:</h4>
        <div class="gallery-container">
          <div class="gallery-main-image">
            <img [src]="'http://localhost:8080/api/images/uploads/' + selectedEvent?.extendedProps?.images[currentImageIndex].path"
                 [alt]="selectedEvent?.extendedProps?.images[currentImageIndex].description || 'Imagine eveniment'">
          </div>

          <div class="gallery-navigation" *ngIf="selectedEvent?.extendedProps?.images.length > 1">
            <button class="gallery-nav-button prev" (click)="prevImage()" [disabled]="currentImageIndex === 0">
              &#10094;
            </button>
            <div class="gallery-indicator">
              {{ currentImageIndex + 1 }} / {{ selectedEvent?.extendedProps?.images.length }}
            </div>
            <button class="gallery-nav-button next" (click)="nextImage()" [disabled]="currentImageIndex === selectedEvent?.extendedProps?.images.length - 1">
              &#10095;
            </button>
          </div>
        </div>
      </div>
      
      <!-- User registration section for non-admin users -->
      <div *ngIf="!isAdmin && selectedEvent?.extendedProps?.fullEventData" class="event-actions">
        <div class="availability-status" 
             [ngClass]="selectedEvent.extendedProps.availableSpots === 0 ? 'full' : (selectedEvent.extendedProps.availableSpots <= 5 ? 'limited' : 'available')"
             *ngIf="!isEventExpired(selectedEvent)">
          <span *ngIf="selectedEvent.extendedProps.availableSpots === 0" class="status-message">
            ğŸš« Eveniment complet
          </span>
          <span *ngIf="selectedEvent.extendedProps.availableSpots > 0 && selectedEvent.extendedProps.availableSpots <= 5" class="status-message">
            âš ï¸ Doar {{ selectedEvent.extendedProps.availableSpots }} locuri rÄƒmase!
          </span>
          <span *ngIf="selectedEvent.extendedProps.availableSpots > 5" class="status-message">
            âœ… {{ selectedEvent.extendedProps.availableSpots }} locuri disponibile
          </span>
        </div>
        
        <button class="register-btn" 
                [disabled]="!canRegisterForEvent(selectedEvent)"
                (click)="showEventRegistration()">
          <i class="btn-icon">âœ‰ï¸</i>
          {{ getEventStatusMessage(selectedEvent) }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- User Registration Modal -->
<div *ngIf="showRegistrationModal" class="modal-overlay" (click)="closeRegistrationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Ãnregistrare la eveniment</h3>
      <button class="close-btn" (click)="closeRegistrationModal()">&times;</button>
    </div>
    
    <div *ngIf="selectedEvent" class="event-details">
      <h4>{{ selectedEvent.title }}</h4>
      <p><strong>ğŸ“… Data:</strong> {{ selectedEvent.start | date:'dd.MM.yyyy HH:mm' }}</p>
      <p *ngIf="selectedEvent.extendedProps?.location"><strong>ğŸ“ LocaÈ›ia:</strong> {{ selectedEvent.extendedProps.location }}</p>
      <p *ngIf="selectedEvent.extendedProps?.description"><strong>ğŸ“ Descriere:</strong> {{ selectedEvent.extendedProps.description }}</p>
    </div>
    
    <form (ngSubmit)="registerForEvent()" class="registration-form">
      <div class="form-group">
        <label for="nume">Nume *</label>
        <input
          type="text"
          id="nume"
          [(ngModel)]="registrationForm.nume"
          name="nume"
          required
          placeholder="IntroduceÈ›i numele dumneavoastrÄƒ"
        />
      </div>
      
      <div class="form-group">
        <label for="prenume">Prenume *</label>
        <input
          type="text"
          id="prenume"
          [(ngModel)]="registrationForm.prenume"
          name="prenume"
          required
          placeholder="IntroduceÈ›i prenumele dumneavoastrÄƒ"
        />
      </div>
      
      <div class="form-group">
        <label for="email">Email *</label>
        <input
          type="email"
          id="email"
          [(ngModel)]="registrationForm.email"
          name="email"
          required
          placeholder="nume@exemplu.com"
        />
      </div>
      
      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="closeRegistrationModal()">
          AnuleazÄƒ
        </button>
        <button type="submit" class="submit-btn">
          Ãnscrie-te
        </button>
      </div>
    </form>
  </div>
</div>

<div class="event-modal" *ngIf="showEditEventModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Editare eveniment</h3>
      <button class="close-btn" (click)="closeEditModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form [formGroup]="editEventForm">
        <div class="form-group">
          <label for="editEventName">Numele evenimentului:</label>
          <input 
            type="text" 
            id="editEventName" 
            formControlName="name" 
            placeholder="Introdu numele evenimentului"
            class="form-control">
          <div class="error-message" *ngIf="editEventForm.get('name')?.invalid && editEventForm.get('name')?.touched">
            Numele evenimentului este obligatoriu
          </div>
        </div>
        
        <div class="form-group">
          <label for="editEventDescription">Descriere:</label>
          <textarea 
            id="editEventDescription" 
            formControlName="description" 
            placeholder="Descriere eveniment"
            class="form-control"
            rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label for="editEventLocation">LocaÈ›ia:</label>
          <input 
            type="text" 
            id="editEventLocation" 
            formControlName="location" 
            placeholder="Introdu locaÈ›ia evenimentului"
            class="form-control">
        </div>
        
        <div class="form-group">
          <label for="editStartDate">Data Ã®nceput:</label>
          <input 
            type="date" 
            id="editStartDate" 
            formControlName="startDate" 
            class="form-control date-input">
          <div class="error-message" *ngIf="editEventForm.get('startDate')?.invalid && editEventForm.get('startDate')?.touched">
            Data de Ã®nceput este obligatorie
          </div>
          <div class="error-message" *ngIf="editEventForm.errors?.['startDateOutOfRange']">
            Data de Ã®nceput trebuie sÄƒ fie Ã®n intervalul permis
          </div>
        </div>
        
        <div class="form-group">
          <label for="editEndDate">Data sfÃ¢rÈ™it:</label>
          <input 
            type="date" 
            id="editEndDate" 
            formControlName="endDate" 
            class="form-control date-input">
          <div class="error-message" *ngIf="editEventForm.get('endDate')?.invalid && editEventForm.get('endDate')?.touched">
            Data de sfÃ¢rÈ™it este obligatorie
          </div>
          <div class="error-message" *ngIf="editEventForm.errors?.['dateOrder']">
            Data de sfÃ¢rÈ™it trebuie sÄƒ fie dupÄƒ data de Ã®nceput
          </div>
          <div class="error-message" *ngIf="editEventForm.errors?.['endDateOutOfRange']">
            Data de sfÃ¢rÈ™it trebuie sÄƒ fie Ã®n intervalul permis
          </div>
        </div>
        
        <div class="form-group">
          <label>Imagini existente:</label>
          <div *ngIf="editEventImages.length > 0" class="selected-images">
            <div class="image-list">
              <div class="image-item" *ngFor="let image of editEventImages; let i = index">
                <div class="image-preview">
                  <img [src]="'http://localhost:8080/api/images/uploads/' + image.path" alt="Preview">
                </div>
                <span>{{ image.path | slice:0:20 }}{{ image.path.length > 20 ? '...' : '' }}</span>
                <button type="button" class="remove-btn" (click)="removeEditImage(i)">È˜terge</button>
              </div>
            </div>
          </div>
          
          <label class="mt-3">AdaugÄƒ imagini noi:</label>
          <div class="image-upload">
            <label for="editImageUpload" class="upload-btn">
              <span>SelecteazÄƒ imagini</span>
              <input 
                type="file" 
                id="editImageUpload" 
                accept="image/*" 
                (change)="onEditFileSelected($event)" 
                class="file-input">
            </label>
            <div *ngIf="editSelectedFile" class="selected-file">
              {{ editSelectedFile.name }}
              <button type="button" class="upload-action-btn" (click)="uploadEditImage()">ÃncarcÄƒ</button>
              <button type="button" class="upload-action-btn cancel" (click)="cancelEditUpload()">AnuleazÄƒ</button>
            </div>
          </div>
          
          <div *ngIf="editUploadProgress > 0 && editUploadProgress < 100" class="upload-progress">
            <div class="progress-bar" [style.width.%]="editUploadProgress"></div>
            <span class="progress-text">{{ editUploadProgress }}%</span>
          </div>
        </div>
        
      </form>
    </div>
    
    <div class="form-actions">
      <button 
        type="button" 
        class="cancel-btn" 
        (click)="closeEditModal()">
        AnuleazÄƒ
      </button>
      <button 
        type="button" 
        class="save-btn" 
        [disabled]="editEventForm.invalid"
        (click)="saveEditedEvent()">
        SalveazÄƒ
      </button>
    </div>
  </div>
</div>